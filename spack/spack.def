Bootstrap: localimage
From: /home/hadrien/Software/singularity-images/tumbleweed.sif

%post
    # Install some dependencies of Spack
    zypper in -y gcc gcc-c++ gcc-fortran git python python-xml

    # Install an environment module system
    zypper in -y lua-lmod
    echo "source /usr/share/lmod/lmod/init/bash" >> ${SINGULARITY_ENVIRONMENT}

    # Install Spack itself
    cd /opt
    git clone --depth=1 https://github.com/spack/spack.git
    echo "source /opt/spack/share/spack/setup-env.sh" >> ${SINGULARITY_ENVIRONMENT}

    # It seems spack find must run at least once with a writable filesystem
    source /opt/spack/share/spack/setup-env.sh
    spack find

    # Discard the system package cache to save up space
    zypper clean

%test
    source /opt/spack/share/spack/setup-env.sh
    spack find
    spack help